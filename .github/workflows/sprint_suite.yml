name: "Sprint Suite"

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  sprint1_test_quality:
    name: "Sprint 1 – Core Testing & Quality"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.9'
      - run: pip install -e .[dev,audio,all]
      - run: pytest tests_music-brain/ -v
      - run: pytest tests_penta-core/ -v || true

  sprint2_core_integration:
    name: "Sprint 2 – Core Integration"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: C++ Build & Test
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake g++
          mkdir build && cd build
          cmake .. -DCMAKE_BUILD_TYPE=Release
          cmake --build . -j
          ctest --output-on-failure

  sprint3_documentation:
    name: "Sprint 3 – Documentation"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Check Markdown files
        run: |
          npm install -g markdownlint-cli
          markdownlint '**/*.md'
      - name: Run example scripts
        run: |
          pip install -e .[all]
          python examples_music-brain/example.py || true

  sprint5_platform:
    name: "Sprint 5 – Platform (${{ matrix.os }}, Python ${{ matrix.python-version }})"
    runs-on: ${{ matrix.os }}
    permissions:
      contents: read
    strategy:
      fail-fast: false
      matrix:
        os: [ ubuntu-latest, macos-latest, windows-latest ]
        python-version: [ '3.9', '3.10', '3.11', '3.12', '3.13' ]
        exclude:
          # Reduce matrix size - test all Python versions on Linux only
          - os: macos-latest
            python-version: '3.10'
          - os: macos-latest
            python-version: '3.13'
          - os: windows-latest
            python-version: '3.10'
          - os: windows-latest
            python-version: '3.13'
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          allow-prereleases: true
      
      - name: Display Python version
        run: python --version
      
      - name: Install system dependencies (Ubuntu)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y libasound2-dev portaudio19-dev libsndfile1-dev
      
      - name: Install system dependencies (macOS)
        if: runner.os == 'macOS'
        run: |
          brew install portaudio libsndfile
      
      - name: Install package
        run: |
          python -m pip install --upgrade pip
          pip install -e .[all]
      
      - name: Run tests
        run: |
          pip install pytest pytest-mock
          pytest tests_music-brain/ -v --tb=short
      
      - name: Test CLI commands
        run: |
          daiw --version
          daiw --help

  sprint6_advanced_theory_ai:
    name: "Sprint 6 – Advanced Theory and AI"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.9'
      - run: pip install -e .[theory,audio,all]
      - run: pytest tests_music-brain/ -v --disable-warnings

  sprint7_mobile_web:
    name: "Sprint 7 – Mobile/Web"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.9'
      - run: pip install -e .[ui,all]
      - name: Launch Streamlit (optional, headless)
        run: |
          streamlit run app.py --headless &
          sleep 10

  sprint8_enterprise:
    name: "Sprint 8 – Enterprise"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.9'
      - run: pip install -e .[all]
      - run: pytest tests_music-brain/ -v
