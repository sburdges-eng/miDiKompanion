name: Build macOS App

on:
  push:
    branches: [main, 'claude/**']
    tags:
      - 'v*'
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  build-macos:
    runs-on: macos-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install PySide6>=6.5.0 py2app>=0.28.0

      - name: Generate app icon
        run: |
          # Create iconset directory
          mkdir -p Bulling.iconset

          # Generate icon using Python
          python3 << 'EOF'
          from PySide6.QtWidgets import QApplication
          from PySide6.QtGui import QPainter, QColor, QBrush, QPen, QRadialGradient, QLinearGradient
          from PySide6.QtCore import Qt, QRectF, QPointF
          from PySide6.QtSvg import QSvgGenerator
          import sys

          app = QApplication(sys.argv)

          # Create SVG icon
          generator = QSvgGenerator()
          generator.setFileName("bulling_icon.svg")
          generator.setSize(Qt.QSize(1024, 1024))
          generator.setViewBox(QRectF(0, 0, 1024, 1024))

          painter = QPainter()
          painter.begin(generator)
          painter.setRenderHint(QPainter.Antialiasing)

          # Background circle (brown bull head)
          gradient = QRadialGradient(512, 512, 450)
          gradient.setColorAt(0, QColor("#8B4513"))
          gradient.setColorAt(1, QColor("#5D2E0C"))
          painter.setBrush(QBrush(gradient))
          painter.setPen(QPen(QColor("#3D1E0C"), 8))
          painter.drawEllipse(QRectF(50, 50, 924, 924))

          # Bull snout
          painter.setBrush(QBrush(QColor("#D4A574")))
          painter.setPen(QPen(QColor("#8B4513"), 4))
          painter.drawEllipse(QRectF(312, 550, 400, 300))

          # Nostrils
          painter.setBrush(QBrush(QColor("#2C1810")))
          painter.drawEllipse(QRectF(380, 680, 60, 80))
          painter.drawEllipse(QRectF(584, 680, 60, 80))

          # Dartboard eyes (left)
          eye_left_x, eye_left_y = 280, 350
          # Outer ring - black
          painter.setBrush(QBrush(QColor("#1D1D1F")))
          painter.drawEllipse(QRectF(eye_left_x, eye_left_y, 180, 180))
          # White ring
          painter.setBrush(QBrush(QColor("#FFFFFF")))
          painter.drawEllipse(QRectF(eye_left_x+20, eye_left_y+20, 140, 140))
          # Green ring
          painter.setBrush(QBrush(QColor("#34C759")))
          painter.drawEllipse(QRectF(eye_left_x+40, eye_left_y+40, 100, 100))
          # Red bullseye
          painter.setBrush(QBrush(QColor("#FF3B30")))
          painter.drawEllipse(QRectF(eye_left_x+60, eye_left_y+60, 60, 60))
          # Center dot
          painter.setBrush(QBrush(QColor("#1D1D1F")))
          painter.drawEllipse(QRectF(eye_left_x+80, eye_left_y+80, 20, 20))

          # Dartboard eyes (right)
          eye_right_x, eye_right_y = 564, 350
          painter.setBrush(QBrush(QColor("#1D1D1F")))
          painter.drawEllipse(QRectF(eye_right_x, eye_right_y, 180, 180))
          painter.setBrush(QBrush(QColor("#FFFFFF")))
          painter.drawEllipse(QRectF(eye_right_x+20, eye_right_y+20, 140, 140))
          painter.setBrush(QBrush(QColor("#34C759")))
          painter.drawEllipse(QRectF(eye_right_x+40, eye_right_y+40, 100, 100))
          painter.setBrush(QBrush(QColor("#FF3B30")))
          painter.drawEllipse(QRectF(eye_right_x+60, eye_right_y+60, 60, 60))
          painter.setBrush(QBrush(QColor("#1D1D1F")))
          painter.drawEllipse(QRectF(eye_right_x+80, eye_right_y+80, 20, 20))

          # Bowling pin horns (left)
          painter.setBrush(QBrush(QColor("#FFFFFF")))
          painter.setPen(QPen(QColor("#E5E5E5"), 4))
          painter.drawEllipse(QRectF(100, 80, 120, 200))
          # Red stripe
          painter.setBrush(QBrush(QColor("#FF3B30")))
          painter.drawRect(QRectF(125, 200, 70, 30))

          # Bowling pin horns (right)
          painter.setBrush(QBrush(QColor("#FFFFFF")))
          painter.setPen(QPen(QColor("#E5E5E5"), 4))
          painter.drawEllipse(QRectF(804, 80, 120, 200))
          painter.setBrush(QBrush(QColor("#FF3B30")))
          painter.drawRect(QRectF(829, 200, 70, 30))

          painter.end()
          print("Icon SVG created successfully")
          EOF

          # Convert SVG to PNG using sips (macOS built-in)
          # First convert to PNG using rsvg-convert or qlmanage
          if command -v rsvg-convert &> /dev/null; then
            for size in 16 32 64 128 256 512 1024; do
              rsvg-convert -w $size -h $size bulling_icon.svg -o "Bulling.iconset/icon_${size}x${size}.png"
              if [ $size -le 512 ]; then
                rsvg-convert -w $((size*2)) -h $((size*2)) bulling_icon.svg -o "Bulling.iconset/icon_${size}x${size}@2x.png"
              fi
            done
          else
            # Use sips with a placeholder PNG approach
            # Create a simple placeholder icon
            python3 << 'PYEOF'
          from PySide6.QtWidgets import QApplication
          from PySide6.QtGui import QImage, QPainter, QColor, QBrush, QPen, QRadialGradient
          from PySide6.QtCore import Qt, QRectF
          import sys

          app = QApplication(sys.argv)

          sizes = [16, 32, 64, 128, 256, 512, 1024]
          for size in sizes:
              image = QImage(size, size, QImage.Format_ARGB32)
              image.fill(Qt.transparent)

              painter = QPainter(image)
              painter.setRenderHint(QPainter.Antialiasing)

              # Background
              gradient = QRadialGradient(size/2, size/2, size/2)
              gradient.setColorAt(0, QColor("#8B4513"))
              gradient.setColorAt(1, QColor("#5D2E0C"))
              painter.setBrush(QBrush(gradient))
              painter.setPen(QPen(QColor("#3D1E0C"), max(1, size//128)))
              painter.drawEllipse(QRectF(size*0.05, size*0.05, size*0.9, size*0.9))

              # Simple eyes
              eye_size = size * 0.15
              painter.setBrush(QBrush(QColor("#FFFFFF")))
              painter.drawEllipse(QRectF(size*0.25, size*0.35, eye_size, eye_size))
              painter.drawEllipse(QRectF(size*0.6, size*0.35, eye_size, eye_size))

              # Pupils
              pupil_size = eye_size * 0.4
              painter.setBrush(QBrush(QColor("#FF3B30")))
              painter.drawEllipse(QRectF(size*0.25 + eye_size*0.3, size*0.35 + eye_size*0.3, pupil_size, pupil_size))
              painter.drawEllipse(QRectF(size*0.6 + eye_size*0.3, size*0.35 + eye_size*0.3, pupil_size, pupil_size))

              # Snout
              painter.setBrush(QBrush(QColor("#D4A574")))
              painter.drawEllipse(QRectF(size*0.3, size*0.55, size*0.4, size*0.3))

              painter.end()

              image.save(f"Bulling.iconset/icon_{size}x{size}.png")
              if size <= 512:
                  # Create @2x version
                  image2x = QImage(size*2, size*2, QImage.Format_ARGB32)
                  image2x.fill(Qt.transparent)
                  painter2x = QPainter(image2x)
                  painter2x.setRenderHint(QPainter.Antialiasing)
                  s = size * 2
                  gradient = QRadialGradient(s/2, s/2, s/2)
                  gradient.setColorAt(0, QColor("#8B4513"))
                  gradient.setColorAt(1, QColor("#5D2E0C"))
                  painter2x.setBrush(QBrush(gradient))
                  painter2x.setPen(QPen(QColor("#3D1E0C"), max(1, s//128)))
                  painter2x.drawEllipse(QRectF(s*0.05, s*0.05, s*0.9, s*0.9))
                  eye_size = s * 0.15
                  painter2x.setBrush(QBrush(QColor("#FFFFFF")))
                  painter2x.drawEllipse(QRectF(s*0.25, s*0.35, eye_size, eye_size))
                  painter2x.drawEllipse(QRectF(s*0.6, s*0.35, eye_size, eye_size))
                  pupil_size = eye_size * 0.4
                  painter2x.setBrush(QBrush(QColor("#FF3B30")))
                  painter2x.drawEllipse(QRectF(s*0.25 + eye_size*0.3, s*0.35 + eye_size*0.3, pupil_size, pupil_size))
                  painter2x.drawEllipse(QRectF(s*0.6 + eye_size*0.3, s*0.35 + eye_size*0.3, pupil_size, pupil_size))
                  painter2x.setBrush(QBrush(QColor("#D4A574")))
                  painter2x.drawEllipse(QRectF(s*0.3, s*0.55, s*0.4, s*0.3))
                  painter2x.end()
                  image2x.save(f"Bulling.iconset/icon_{size}x{size}@2x.png")

          print("Icon PNGs created successfully")
          PYEOF
          fi

          # Create .icns file
          iconutil -c icns Bulling.iconset -o app_icon.icns
          echo "Created app_icon.icns"

      - name: Build macOS app with py2app
        run: |
          python setup.py py2app

      - name: Create DMG
        run: |
          # Create a DMG file for easy distribution
          mkdir -p dist/dmg
          cp -R dist/Bulling.app dist/dmg/

          # Create a symlink to Applications folder
          ln -s /Applications dist/dmg/Applications

          # Create DMG
          hdiutil create -volname "Bulling" -srcfolder dist/dmg -ov -format UDZO dist/Bulling-macOS.dmg

          echo "DMG created successfully"

      - name: Create ZIP archive
        run: |
          cd dist
          zip -r Bulling-macOS.zip Bulling.app
          cd ..

      - name: Upload macOS App Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Bulling-macOS-App
          path: dist/Bulling.app
          retention-days: 30

      - name: Upload DMG Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Bulling-macOS-DMG
          path: dist/Bulling-macOS.dmg
          retention-days: 30

      - name: Upload ZIP Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Bulling-macOS-ZIP
          path: dist/Bulling-macOS.zip
          retention-days: 30

      - name: Create Release
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v1
        with:
          files: |
            dist/Bulling-macOS.dmg
            dist/Bulling-macOS.zip
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
