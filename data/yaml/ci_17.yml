name: DAiW CI

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

jobs:
  # =============================================================================
  # Python Tests
  # =============================================================================
  test:
    name: Run Python tests
    runs-on: ubuntu-latest

    strategy:
      matrix:
        python-version: ["3.9", "3.11"]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install package + test deps
        run: |
          python -m pip install --upgrade pip
          # Install daiw package from pyproject.toml
          pip install -e .
          # Test tooling
          pip install pytest pytest-mock pytest-cov

      - name: Run tests with coverage
        run: |
          pytest tests/ -v --cov=music_brain --cov-report=xml --cov-report=term-missing

      - name: Upload coverage to Codecov
        if: matrix.python-version == '3.11'
        uses: codecov/codecov-action@v4
        with:
          file: ./coverage.xml
          flags: python
          name: python-coverage

  # =============================================================================
  # C++ Build and Tests
  # =============================================================================
  cpp-build:
    name: Build C++ (${{ matrix.os }})
    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]
        include:
          - os: ubuntu-latest
            cmake_flags: "-DCMAKE_BUILD_TYPE=Release -DCMAKE_CXX_FLAGS=-fprofile-arcs -DCMAKE_CXX_FLAGS=-ftest-coverage"
          - os: macos-latest
            cmake_flags: "-DCMAKE_BUILD_TYPE=Release"

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install dependencies (Ubuntu)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake g++ lcov ninja-build

      - name: Install dependencies (macOS)
        if: runner.os == 'macOS'
        run: |
          brew install cmake ninja lcov

      - name: Configure CMake
        run: |
          mkdir -p build
          cd build
          cmake .. ${{ matrix.cmake_flags }} -G Ninja

      - name: Build penta-core
        run: |
          cd build
          ninja penta_core || cmake --build . --target penta_core -j$(nproc 2>/dev/null || sysctl -n hw.ncpu)

      - name: Build tests
        run: |
          cd build
          ninja penta_tests || cmake --build . --target penta_tests -j$(nproc 2>/dev/null || sysctl -n hw.ncpu) || true

      - name: Run C++ tests
        run: |
          cd build
          ctest --output-on-failure || true

      - name: Generate C++ coverage (Ubuntu only)
        if: runner.os == 'Linux'
        run: |
          cd build
          lcov --capture --directory . --output-file coverage.info --ignore-errors mismatch || true
          lcov --remove coverage.info '/usr/*' '*/tests/*' '*/external/*' --output-file coverage.info || true
          lcov --list coverage.info || true

      - name: Upload C++ coverage
        if: runner.os == 'Linux'
        uses: codecov/codecov-action@v4
        with:
          file: ./build/coverage.info
          flags: cpp
          name: cpp-coverage
        continue-on-error: true

  # =============================================================================
  # Memory Testing with Valgrind
  # =============================================================================
  memory-testing:
    name: Memory testing (Valgrind)
    runs-on: ubuntu-latest
    needs: cpp-build

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake g++ valgrind ninja-build

      - name: Configure CMake (Debug for better Valgrind output)
        run: |
          mkdir -p build
          cd build
          cmake .. -DCMAKE_BUILD_TYPE=Debug -G Ninja

      - name: Build tests
        run: |
          cd build
          ninja penta_tests || cmake --build . --target penta_tests -j$(nproc) || true

      - name: Run Valgrind memory check
        run: |
          cd build
          # Run with memcheck for memory leak detection
          valgrind --leak-check=full \
                   --show-leak-kinds=all \
                   --track-origins=yes \
                   --error-exitcode=1 \
                   --suppressions=../valgrind.supp \
                   ./penta_tests 2>&1 | tee valgrind-report.txt || true

      - name: Upload Valgrind report
        uses: actions/upload-artifact@v4
        with:
          name: valgrind-report
          path: build/valgrind-report.txt
        if: always()

  # =============================================================================
  # Performance Regression Testing
  # =============================================================================
  performance-testing:
    name: Performance regression testing
    runs-on: ubuntu-latest
    needs: cpp-build

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake g++ ninja-build python3-pip
          pip3 install pytest pytest-benchmark

      - name: Configure CMake (Release for accurate benchmarks)
        run: |
          mkdir -p build
          cd build
          cmake .. -DCMAKE_BUILD_TYPE=Release -G Ninja

      - name: Build library
        run: |
          cd build
          ninja penta_core || cmake --build . --target penta_core -j$(nproc)

      - name: Run C++ performance tests
        run: |
          cd build
          # Run tests with timing output
          ./penta_tests --gtest_filter="*Performance*" || true

      - name: Run Python performance benchmarks
        run: |
          pip install -e .[all]
          pytest tests_music-brain/test_performance.py -v --benchmark-only --benchmark-json=benchmark-results.json || true

      - name: Upload benchmark results
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-results
          path: benchmark-results.json
        if: always()

      - name: Check for performance regression
        run: |
          # Simple latency check - verify core operations complete under target times
          python3 -c "
          import json
          import sys
          try:
              with open('benchmark-results.json') as f:
                  results = json.load(f)
              # Check if any benchmark exceeds 200ms (groove latency target)
              for bench in results.get('benchmarks', []):
                  mean_ms = bench.get('stats', {}).get('mean', 0) * 1000
                  if mean_ms > 200:
                      print(f'Warning: {bench[\"name\"]} took {mean_ms:.2f}ms (target: <200ms)')
              print('Performance check completed')
          except Exception as e:
              print(f'Performance check skipped: {e}')
          "

  build-desktop-macos:
    name: Build desktop app (macOS)
    needs: [test, cpp-build]
    runs-on: macos-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install package + build deps
        run: |
          python -m pip install --upgrade pip
          pip install -e .
          pip install streamlit pywebview pyinstaller

      - name: Build DAiW app with PyInstaller
        run: |
          pyinstaller daiw.spec --clean --noconfirm

      - name: Upload built app (macOS)
        uses: actions/upload-artifact@v4
        with:
          name: DAiW-dist-macos
          path: dist/DAiW.app/

  build-desktop-linux:
    name: Build desktop app (Linux)
    needs: [test, cpp-build]
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y python3-gi python3-gi-cairo gir1.2-gtk-3.0 gir1.2-webkit2-4.1

      - name: Install package + build deps
        run: |
          python -m pip install --upgrade pip
          pip install -e .
          pip install streamlit pywebview pyinstaller

      - name: Build DAiW app with PyInstaller
        run: |
          pyinstaller daiw.spec --clean --noconfirm

      - name: Upload built app (Linux)
        uses: actions/upload-artifact@v4
        with:
          name: DAiW-dist-linux
          path: dist/DAiW/

  build-desktop-windows:
    name: Build desktop app (Windows)
    needs: [test, cpp-build]
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install package + build deps
        run: |
          python -m pip install --upgrade pip
          pip install -e .
          pip install streamlit pywebview pyinstaller

      - name: Build DAiW app with PyInstaller
        run: |
          pyinstaller daiw.spec --clean --noconfirm

      - name: Upload built app (Windows)
        uses: actions/upload-artifact@v4
        with:
          name: DAiW-dist-windows
          path: dist/DAiW/
